CACHE_VERSION = 'v1'
CACHE_NAME = 'sw-cache-' + CACHE_VERSION

onInstall = (event) ->
  console.log '[Serviceworker]', 'Installing!', event
  event.waitUntil caches.open(CACHE_NAME).then((cache) ->
    cache.addAll [
      '<%#= asset_path "application.js" %>'
      '<%= asset_path "application.css" %>'
      '/offline.html'
    ]
  )
  return

onActivate = (event) ->
  console.log '[Serviceworker]', 'Activating!', event
  event.waitUntil caches.keys().then((cacheNames) ->
    Promise.all cacheNames.filter((cacheName) ->
      # Return true if you want to remove this cache,
      # but remember that caches are shared across
      # the whole origin
      cacheName.indexOf(CACHE_VERSION) != 0
    ).map((cacheName) ->
      caches.delete cacheName
    )
  )
  return

# Borrowed from https://github.com/TalAter/UpUp

onFetch = (event) ->
  event.respondWith fetch(event.request).catch(->
    # if it fails, try to return request from the cache
    caches.match(event.request).then (response) ->
      if response
        return response
      # if not found in cache, return default offline content for navigate requests
      if event.request.mode == 'navigate' or event.request.method == 'GET' and event.request.headers.get('accept').includes('text/html')
        console.log '[Serviceworker]', 'Fetching offline content', event
        return caches.match('/offline.html')
      return
  )
  return

self.addEventListener 'install', onInstall
self.addEventListener 'activate', onActivate
self.addEventListener 'fetch', onFetch
